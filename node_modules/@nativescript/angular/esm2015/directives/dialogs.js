import { ComponentFactoryResolver, Injectable, Injector, NgZone } from '@angular/core';
import { Frame } from '@nativescript/core';
import { NSLocationStrategy } from '../router/ns-location-strategy';
import { AppHostView, AppHostAsyncView } from '../app-host-view';
import { DetachedLoader } from '../common/detached-loader';
import { PAGE_FACTORY } from '../platform-providers';
import { once } from '../common/utils';
export class ModalDialogParams {
    constructor(context = {}, closeCallback) {
        this.context = context;
        this.closeCallback = closeCallback;
    }
}
export class ModalDialogService {
    constructor(location, zone) {
        this.location = location;
        this.zone = zone;
    }
    showModal(type, options) {
        if (!options.viewContainerRef) {
            throw new Error('No viewContainerRef: ' + 'Make sure you pass viewContainerRef in ModalDialogOptions.');
        }
        let parentView = options.viewContainerRef.element.nativeElement;
        if (options.target) {
            parentView = options.target;
        }
        if ((parentView instanceof AppHostView || parentView instanceof AppHostAsyncView) && parentView.ngAppRoot) {
            parentView = parentView.ngAppRoot;
        }
        // _ngDialogRoot is the first child of the previously detached proxy.
        // It should have 'viewController' (iOS) or '_dialogFragment' (Android) available for
        // presenting future modal views.
        if (parentView._ngDialogRoot) {
            parentView = parentView._ngDialogRoot;
        }
        const pageFactory = options.viewContainerRef.injector.get(PAGE_FACTORY);
        // resolve from particular module (moduleRef)
        // or from same module as parentView (viewContainerRef)
        const componentContainer = options.moduleRef || options.viewContainerRef;
        const resolver = componentContainer.injector.get(ComponentFactoryResolver);
        let frame = parentView;
        if (!(parentView instanceof Frame)) {
            frame = (parentView.page && parentView.page.frame) || Frame.topmost();
        }
        this.location._beginModalNavigation(frame);
        return new Promise((resolve, reject) => {
            setTimeout(() => {
                try {
                    this._showDialog(Object.assign(Object.assign({}, options), { containerRef: options.viewContainerRef, context: options.context, doneCallback: resolve, pageFactory,
                        parentView,
                        resolver,
                        type }));
                }
                catch (err) {
                    reject(err);
                }
            }, 10);
        });
    }
    _showDialog(options) {
        let componentView;
        let detachedLoaderRef;
        const closeCallback = once((...args) => {
            options.doneCallback.apply(undefined, args);
            if (componentView) {
                componentView.closeModal();
                this.location._closeModalNavigation();
                this.zone.run(() => {
                    detachedLoaderRef.instance.detectChanges();
                    detachedLoaderRef.destroy();
                });
            }
        });
        const modalParams = new ModalDialogParams(options.context, closeCallback);
        const childInjector = Injector.create({
            providers: [{ provide: ModalDialogParams, useValue: modalParams }],
            parent: options.containerRef.injector,
        });
        const detachedFactory = options.resolver.resolveComponentFactory(DetachedLoader);
        detachedLoaderRef = options.containerRef.createComponent(detachedFactory, 0, childInjector, null);
        this.zone.run(() => {
            detachedLoaderRef.instance.loadComponent(options.type).then((compRef) => {
                const detachedProxy = compRef.location.nativeElement;
                if (detachedProxy.getChildrenCount() > 1) {
                    throw new Error('Modal content has more than one root view.');
                }
                componentView = detachedProxy.getChildAt(0);
                if (componentView.parent) {
                    componentView.parent._ngDialogRoot = componentView;
                    componentView.parent.removeChild(componentView);
                }
                options.parentView.showModal(componentView, Object.assign(Object.assign({}, options), { closeCallback }));
            });
        });
    }
}
ModalDialogService.decorators = [
    { type: Injectable }
];
ModalDialogService.ctorParameters = () => [
    { type: NSLocationStrategy },
    { type: NgZone }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9ncy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8iLCJzb3VyY2VzIjpbImRpcmVjdGl2ZXMvZGlhbG9ncy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsd0JBQXdCLEVBQWdCLFVBQVUsRUFBRSxRQUFRLEVBQWUsTUFBTSxFQUEwQixNQUFNLGVBQWUsQ0FBQztBQUMxSSxPQUFPLEVBQUUsS0FBSyxFQUF3RCxNQUFNLG9CQUFvQixDQUFDO0FBRWpHLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxXQUFXLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUNqRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDM0QsT0FBTyxFQUFlLFlBQVksRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQXFCdkMsTUFBTSxPQUFPLGlCQUFpQjtJQUM3QixZQUFtQixVQUFlLEVBQUUsRUFBUyxhQUErQjtRQUF6RCxZQUFPLEdBQVAsT0FBTyxDQUFVO1FBQVMsa0JBQWEsR0FBYixhQUFhLENBQWtCO0lBQUcsQ0FBQztDQUNoRjtBQUdELE1BQU0sT0FBTyxrQkFBa0I7SUFDOUIsWUFBb0IsUUFBNEIsRUFBVSxJQUFZO1FBQWxELGFBQVEsR0FBUixRQUFRLENBQW9CO1FBQVUsU0FBSSxHQUFKLElBQUksQ0FBUTtJQUFHLENBQUM7SUFFbkUsU0FBUyxDQUFDLElBQWUsRUFBRSxPQUEyQjtRQUM1RCxJQUFJLENBQUMsT0FBTyxDQUFDLGdCQUFnQixFQUFFO1lBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsdUJBQXVCLEdBQUcsNERBQTRELENBQUMsQ0FBQztTQUN4RztRQUVELElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDO1FBQ2hFLElB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Y3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBJbmplY3RhYmxlLCBJbmplY3RvciwgTmdNb2R1bGVSZWYsIE5nWm9uZSwgVHlwZSwgVmlld0NvbnRhaW5lclJlZiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRnJhbWUsIFZpZXcsIFZpZXdCYXNlLCBQcm94eVZpZXdDb250YWluZXIsIFNob3dNb2RhbE9wdGlvbnMgfSBmcm9tICdAbmF0aXZlc2NyaXB0L2NvcmUnO1xuXG5pbXBvcnQgeyBOU0xvY2F0aW9uU3RyYXRlZ3kgfSBmcm9tICcuLi9yb3V0ZXIvbnMtbG9jYXRpb24tc3RyYXRlZ3knO1xuaW1wb3J0IHsgQXBwSG9zdFZpZXcsIEFwcEhvc3RBc3luY1ZpZXcgfSBmcm9tICcuLi9hcHAtaG9zdC12aWV3JztcbmltcG9ydCB7IERldGFjaGVkTG9hZGVyIH0gZnJvbSAnLi4vY29tbW9uL2RldGFjaGVkLWxvYWRlcic7XG5pbXBvcnQgeyBQYWdlRmFjdG9yeSwgUEFHRV9GQUNUT1JZIH0gZnJvbSAnLi4vcGxhdGZvcm0tcHJvdmlkZXJzJztcbmltcG9ydCB7IG9uY2UgfSBmcm9tICcuLi9jb21tb24vdXRpbHMnO1xuXG5leHBvcnQgdHlwZSBCYXNlU2hvd01vZGFsT3B0aW9ucyA9IFBpY2s8U2hvd01vZGFsT3B0aW9ucywgRXhjbHVkZTxrZXlvZiBTaG93TW9kYWxPcHRpb25zLCAnY2xvc2VDYWxsYmFjaycgfCAnY29udGV4dCc+PjtcblxuZXhwb3J0IGludGVyZmFjZSBNb2RhbERpYWxvZ09wdGlvbnMgZXh0ZW5kcyBCYXNlU2hvd01vZGFsT3B0aW9ucyB7XG5cdGNvbnRleHQ/OiBhbnk7XG5cdHZpZXdDb250YWluZXJSZWY/OiBWaWV3Q29udGFpbmVyUmVmO1xuXHRtb2R1bGVSZWY/OiBOZ01vZHVsZVJlZjxhbnk+O1xuXHR0YXJnZXQ/OiBWaWV3O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNob3dEaWFsb2dPcHRpb25zIGV4dGVuZHMgQmFzZVNob3dNb2RhbE9wdGlvbnMge1xuXHRjb250YWluZXJSZWY6IFZpZXdDb250YWluZXJSZWY7XG5cdGNvbnRleHQ6IGFueTtcblx0ZG9uZUNhbGxiYWNrO1xuXHRwYWdlRmFjdG9yeTogUGFnZUZhY3Rvcnk7XG5cdHBhcmVudFZpZXc6IFZpZXdCYXNlO1xuXHRyZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyO1xuXHR0eXBlOiBUeXBlPGFueT47XG59XG5cbmV4cG9ydCBjbGFzcyBNb2RhbERpYWxvZ1BhcmFtcyB7XG5cdGNvbnN0cnVjdG9yKHB1YmxpYyBjb250ZXh0OiBhbnkgPSB7fSwgcHVibGljIGNsb3NlQ2FsbGJhY2s6ICguLi5hcmdzKSA9PiBhbnkpIHt9XG59XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBNb2RhbERpYWxvZ1NlcnZpY2Uge1xuXHRjb25zdHJ1Y3Rvcihwcml2YXRlIGxvY2F0aW9uOiBOU0xvY2F0aW9uU3RyYXRlZ3ksIHByaXZhdGUgem9uZTogTmdab25lKSB7fVxuXG5cdHB1YmxpYyBzaG93TW9kYWwodHlwZTogVHlwZTxhbnk+LCBvcHRpb25zOiBNb2RhbERpYWxvZ09wdGlvbnMpOiBQcm9taXNlPGFueT4ge1xuXHRcdGlmICghb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmKSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ05vIHZpZXdDb250YWluZXJSZWY6ICcgKyAnTWFrZSBzdXJlIHlvdSBwYXNzIHZpZXdDb250YWluZXJSZWYgaW4gTW9kYWxEaWFsb2dPcHRpb25zLicpO1xuXHRcdH1cblxuXHRcdGxldCBwYXJlbnRWaWV3ID0gb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmLmVsZW1lbnQubmF0aXZlRWxlbWVudDtcblx0XHRpZiAob3B0aW9ucy50YXJnZXQpIHtcblx0XHRcdHBhcmVudFZpZXcgPSBvcHRpb25zLnRhcmdldDtcblx0XHR9XG5cblx0XHRpZiAoKHBhcmVudFZpZXcgaW5zdGFuY2VvZiBBcHBIb3N0VmlldyB8fCBwYXJlbnRWaWV3IGluc3RhbmNlb2YgQXBwSG9zdEFzeW5jVmlldykgJiYgcGFyZW50Vmlldy5uZ0FwcFJvb3QpIHtcblx0XHRcdHBhcmVudFZpZXcgPSBwYXJlbnRWaWV3Lm5nQXBwUm9vdDtcblx0XHR9XG5cblx0XHQvLyBfbmdEaWFsb2dSb290IGlzIHRoZSBmaXJzdCBjaGlsZCBvZiB0aGUgcHJldmlvdXNseSBkZXRhY2hlZCBwcm94eS5cblx0XHQvLyBJdCBzaG91bGQgaGF2ZSAndmlld0NvbnRyb2xsZXInIChpT1MpIG9yICdfZGlhbG9nRnJhZ21lbnQnIChBbmRyb2lkKSBhdmFpbGFibGUgZm9yXG5cdFx0Ly8gcHJlc2VudGluZyBmdXR1cmUgbW9kYWwgdmlld3MuXG5cdFx0aWYgKHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdCkge1xuXHRcdFx0cGFyZW50VmlldyA9IHBhcmVudFZpZXcuX25nRGlhbG9nUm9vdDtcblx0XHR9XG5cblx0XHRjb25zdCBwYWdlRmFjdG9yeTogUGFnZUZhY3RvcnkgPSBvcHRpb25zLnZpZXdDb250YWluZXJSZWYuaW5qZWN0b3IuZ2V0KFBBR0VfRkFDVE9SWSk7XG5cblx0XHQvLyByZXNvbHZlIGZyb20gcGFydGljdWxhciBtb2R1bGUgKG1vZHVsZVJlZilcblx0XHQvLyBvciBmcm9tIHNhbWUgbW9kdWxlIGFzIHBhcmVudFZpZXcgKHZpZXdDb250YWluZXJSZWYpXG5cdFx0Y29uc3QgY29tcG9uZW50Q29udGFpbmVyID0gb3B0aW9ucy5tb2R1bGVSZWYgfHwgb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmO1xuXHRcdGNvbnN0IHJlc29sdmVyID0gY29tcG9uZW50Q29udGFpbmVyLmluamVjdG9yLmdldChDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIpO1xuXG5cdFx0bGV0IGZyYW1lID0gcGFyZW50Vmlldztcblx0XHRpZiAoIShwYXJlbnRWaWV3IGluc3RhbmNlb2YgRnJhbWUpKSB7XG5cdFx0XHRmcmFtZSA9IChwYXJlbnRWaWV3LnBhZ2UgJiYgcGFyZW50Vmlldy5wYWdlLmZyYW1lKSB8fCBGcmFtZS50b3Btb3N0KCk7XG5cdFx0fVxuXG5cdFx0dGhpcy5sb2NhdGlvbi5fYmVnaW5Nb2RhbE5hdmlnYXRpb24oZnJhbWUpO1xuXG5cdFx0cmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcblx0XHRcdHNldFRpbWVvdXQoKCkgPT4ge1xuXHRcdFx0XHR0cnkge1xuXHRcdFx0XHRcdHRoaXMuX3Nob3dEaWFsb2coe1xuXHRcdFx0XHRcdFx0Li4ub3B0aW9ucyxcblx0XHRcdFx0XHRcdGNvbnRhaW5lclJlZjogb3B0aW9ucy52aWV3Q29udGFpbmVyUmVmLFxuXHRcdFx0XHRcdFx0Y29udGV4dDogb3B0aW9ucy5jb250ZXh0LFxuXHRcdFx0XHRcdFx0ZG9uZUNhbGxiYWNrOiByZXNvbHZlLFxuXHRcdFx0XHRcdFx0cGFnZUZhY3RvcnksXG5cdFx0XHRcdFx0XHRwYXJlbnRWaWV3LFxuXHRcdFx0XHRcdFx0cmVzb2x2ZXIsXG5cdFx0XHRcdFx0XHR0eXBlLFxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9IGNhdGNoIChlcnIpIHtcblx0XHRcdFx0XHRyZWplY3QoZXJyKTtcblx0XHRcdFx0fVxuXHRcdFx0fSwgMTApO1xuXHRcdH0pO1xuXHR9XG5cblx0cHJpdmF0ZSBfc2hvd0RpYWxvZyhvcHRpb25zOiBTaG93RGlhbG9nT3B0aW9ucyk6IHZvaWQge1xuXHRcdGxldCBjb21wb25lbnRWaWV3OiBWaWV3O1xuXHRcdGxldCBkZXRhY2hlZExvYWRlclJlZjogQ29tcG9uZW50UmVmPERldGFjaGVkTG9hZGVyPjtcblxuXHRcdGNvbnN0IGNsb3NlQ2FsbGJhY2sgPSBvbmNlKCguLi5hcmdzKSA9PiB7XG5cdFx0XHRvcHRpb25zLmRvbmVDYWxsYmFjay5hcHBseSh1bmRlZmluZWQsIGFyZ3MpO1xuXHRcdFx0aWYgKGNvbXBvbmVudFZpZXcpIHtcblx0XHRcdFx0Y29tcG9uZW50Vmlldy5jbG9zZU1vZGFsKCk7XG5cdFx0XHRcdHRoaXMubG9jYXRpb24uX2Nsb3NlTW9kYWxOYXZpZ2F0aW9uKCk7XG5cdFx0XHRcdHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuXHRcdFx0XHRcdGRldGFjaGVkTG9hZGVyUmVmLmluc3RhbmNlLmRldGVjdENoYW5nZXMoKTtcblx0XHRcdFx0XHRkZXRhY2hlZExvYWRlclJlZi5kZXN0cm95KCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fVxuXHRcdH0pO1xuXG5cdFx0Y29uc3QgbW9kYWxQYXJhbXMgPSBuZXcgTW9kYWxEaWFsb2dQYXJhbXMob3B0aW9ucy5jb250ZXh0LCBjbG9zZUNhbGxiYWNrKTtcblxuXHRcdGNvbnN0IGNoaWxkSW5qZWN0b3IgPSBJbmplY3Rvci5jcmVhdGUoe1xuXHRcdFx0cHJvdmlkZXJzOiBbeyBwcm92aWRlOiBNb2RhbERpYWxvZ1BhcmFtcywgdXNlVmFsdWU6IG1vZGFsUGFyYW1zIH1dLFxuXHRcdFx0cGFyZW50OiBvcHRpb25zLmNvbnRhaW5lclJlZi5pbmplY3Rvcixcblx0XHR9KTtcblx0XHRjb25zdCBkZXRhY2hlZEZhY3RvcnkgPSBvcHRpb25zLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KERldGFjaGVkTG9hZGVyKTtcblx0XHRkZXRhY2hlZExvYWRlclJlZiA9IG9wdGlvbnMuY29udGFpbmVyUmVmLmNyZWF0ZUNvbXBvbmVudChkZXRhY2hlZEZhY3RvcnksIDAsIGNoaWxkSW5qZWN0b3IsIG51bGwpO1xuXHRcdHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuXHRcdFx0ZGV0YWNoZWRMb2FkZXJSZWYuaW5zdGFuY2UubG9hZENvbXBvbmVudChvcHRpb25zLnR5cGUpLnRoZW4oKGNvbXBSZWYpID0+IHtcblx0XHRcdFx0Y29uc3QgZGV0YWNoZWRQcm94eSA9IDxQcm94eVZpZXdDb250YWluZXI+Y29tcFJlZi5sb2NhdGlvbi5uYXRpdmVFbGVtZW50O1xuXG5cdFx0XHRcdGlmIChkZXRhY2hlZFByb3h5LmdldENoaWxkcmVuQ291bnQoKSA+IDEpIHtcblx0XHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoJ01vZGFsIGNvbnRlbnQgaGFzIG1vcmUgdGhhbiBvbmUgcm9vdCB2aWV3LicpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGNvbXBvbmVudFZpZXcgPSBkZXRhY2hlZFByb3h5LmdldENoaWxkQXQoMCk7XG5cblx0XHRcdFx0aWYgKGNvbXBvbmVudFZpZXcucGFyZW50KSB7XG5cdFx0XHRcdFx0KDxhbnk+Y29tcG9uZW50Vmlldy5wYXJlbnQpLl9uZ0RpYWxvZ1Jvb3QgPSBjb21wb25lbnRWaWV3O1xuXHRcdFx0XHRcdCg8YW55PmNvbXBvbmVudFZpZXcucGFyZW50KS5yZW1vdmVDaGlsZChjb21wb25lbnRWaWV3KTtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdG9wdGlvbnMucGFyZW50Vmlldy5zaG93TW9kYWwoY29tcG9uZW50VmlldywgeyAuLi5vcHRpb25zLCBjbG9zZUNhbGxiYWNrIH0pO1xuXHRcdFx0fSk7XG5cdFx0fSk7XG5cdH1cbn1cbiJdfQ==